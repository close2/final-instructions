<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Instructions</title>
    <style>
        :root {
            /* Palette: Indigo & Slate */
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            
            /* Spacing & Radius */
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-main);
            background: var(--background);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Modern Card */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }
        
        .vault-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .vault-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }
        
        .vault-add-card {
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            background: transparent;
            min-height: 200px;
        }
        
        .vault-add-card:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }

        h1, h2, h3 {
            color: var(--text-main);
            font-weight: 700;
            letter-spacing: -0.025em;
            margin-bottom: 16px;
        }
        
        h1 { font-size: 2.5rem; }
        h2 { font-size: 1.5rem; }
        
        p { color: var(--text-muted); margin-bottom: 16px; }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: filter 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover { filter: brightness(110%); }
        .btn-secondary { background: var(--surface); color: var(--text-main); border: 1px solid var(--border); }
        .btn-secondary:hover { background: #f1f5f9; }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        
        .btn-icon { padding: 8px; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--background);
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        .hidden { display: none !important; }
        
        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 100;
        }
        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            width: 90%; max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            padding: 0;
        }
        .modal-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 32px; }
        .modal-footer { padding: 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; background: var(--background); }
        
        /* Badge */
        .badge {
            display: inline-flex; align-items: center;
            padding: 4px 10px; border-radius: 999px;
            font-size: 12px; font-weight: 600;
            background: #e0e7ff; color: var(--primary);
        }     .file-list a {
            color: #007bff;
            text-decoration: none;
        }

        .file-list a:hover {
            text-decoration: underline;
        }

        .password-input {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .password-input input {
            flex: 1;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        #main-create-btn { margin-top: 16px; }
        
        .text-main { color: var(--text-main); }
        
        .admin-header, .admin-global-settings, .vault-card-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }

        .admin-actions { display: flex; gap: 8px; }
        
        .greeting-input-group { 
            display: flex; 
            gap: 16px; 
            align-items: center; 
        }
        .greeting-input-group > div:first-child { flex: 1; }
        
        .key-holders-list { 
            margin-bottom: 16px;
            padding: 12px;
            background: #e9ecef;
            border-radius: 4px;
        }
        
        .recovered-keys-list { margin-top: 12px; }
        
        .modal-actions {
            display: flex; 
            justify-content: flex-end; 
            gap: 8px; 
            margin-top: 24px;
        }

        /* Modal Forms */
        .form-column-group {
            display: flex; 
            flex-direction: column; 
            gap: 16px;
        }
        
        .form-row {
            display: flex; 
            gap: 16px; 
            margin-top: 16px;
        }
        .form-col { flex: 1; min-width: 0; }
        
        .share-config-row {
            display: flex; 
            gap: 16px; 
            align-items: flex-end; 
            margin-bottom: 16px;
        }
        .share-config-action { flex: 0 0 auto; }
        .share-config-copy-action { 
            flex: 0 0 auto; 
            display: flex; 
            align-items: flex-end; 
        }
        
        .file-preview-header { display: flex; align-items: center; }

        .modal-file-remove {
            color: var(--danger); 
            cursor: pointer; 
            padding-left: 8px;
        }

        .dist-card { padding: 20px; margin-bottom: 24px; }
        .dist-card-admin { border-left: 4px solid var(--text-main); background: #fff; }
        
        /* Share Row Styles */
        .share-index { 
            font-weight: 600; 
            color: var(--text-muted); 
            width: 24px; 
        }
        .share-cell { flex: 1; }
        .share-name-label { font-weight: 500; }
        .share-value-code { font-size: 12px; color: var(--text-muted); }
        .share-copy-btn { padding: 2px 8px; font-size: 11px; }

        /* File Template Styles */
        .file-download-link { margin-right: 10px; font-size: 12px; }
        .file-remove-btn { padding: 4px 8px; font-size: 12px; margin-bottom: 0; }

        /* Global Settings Description */
        .settings-desc { margin: 0; font-size: 0.9rem; }

        /* Add Card Icon */
        .add-card-icon { margin-bottom: 12px; opacity: 0.5; }

        /* Files Title */
        .files-section-title { margin-top: 24px; }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
        .empty-state-hint { font-size: 0.9em; }

        /* Modal File Drop Zone */
        .file-drop-zone {
            border: 2px dashed var(--border); 
            padding: 20px; 
            text-align: center; 
            border-radius: 8px; 
            cursor: pointer;
        }
        .file-drop-hint { margin-bottom: 8px; }
        .modal-file-list { text-align: left; margin-top: 8px; }

        /* Access Control Section */
        .access-control-title {
            margin-top: 24px; 
            border-top: 1px solid var(--border); 
            padding-top: 24px;
        }

        /* Master Key Input Group */
        .master-key-label { display: block; font-size: 0.8em; margin-bottom: 4px; }
        .master-key-wrapper { display: flex; }
        .master-key-input {
            width: 120px; 
            font-family: monospace; 
            background: #eee; 
            border-radius: 4px 0 0 4px; 
            border-right: none;
        }
        .master-key-copy-btn { border-radius: 0 4px 4px 0; padding: 0 8px; }

        /* Share Table Container */
        .share-table-container {
            background: var(--background); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            overflow: hidden;
        }

        /* Modal Spacer */
        .modal-spacer { flex: 1; }
        
        .code-block { 
            margin-top: 12px; 
            background: #f8fafc; 
            padding: 12px; 
            border-radius: 6px; 
            font-family: monospace; 
            font-size: 13px; 
            white-space: pre-wrap; 
            color: var(--text-muted); 
        }
        
        .file-item {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 4px 0; 
            border-bottom: 1px solid #eee;
        }

        .share-row-modal {
            display: flex; 
            padding: 12px; 
            border-bottom: 1px solid var(--border); 
            align-items: center; 
            gap: 12px;
        }

        .share-row-read-only {
            display: flex; 
            padding: 8px; 
            border-bottom: 1px solid #eee; 
            align-items: center; 
            gap: 12px;
        }
        
        .keys-details {
            margin-top: 24px;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 12px;
        }
        
        .keys-summary {
            cursor: pointer;
            font-weight: bold;
        }

        .bulk-unlock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .bulk-unlock-card {
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            background: var(--surface);
        }
        /* File List Styling */
        .file-list-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        
        .file-list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 6px;
            transition: all 0.2s;
            text-decoration: none;
            color: var(--text-main);
        }
        
        .file-list-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            text-decoration: none;
        }
        
        .file-icon {
            margin-right: 12px;
            color: var(--primary);
            flex-shrink: 0;
        }
        
        .file-info {
            flex: 1;
            min-width: 0; 
        }
        
        .file-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        
        .file-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .file-action-icon {
            margin-left: 12px;
            color: var(--text-muted);
        }

        /* Semantic Refactoring Classes */
        .lang-selector {
            position: absolute; 
            top: 16px; 
            right: 16px; 
            z-index: 100;
        }

        .lang-select-input {
            padding: 4px 8px; 
            border-radius: 4px; 
            border: 1px solid var(--border); 
            background: var(--surface); 
            color: var(--text-main);
        }
        
        .main-greeting-container {
            margin-top: 16px; 
            padding-top: 16px; 
            border-top: 1px solid #eee;
        }

        .main-intro-list {
            margin-left: 20px; 
            margin-top: 8px; 
            margin-bottom: 16px;
        }

        .decrypt-guide-text {
            margin-bottom: 16px; 
            color: #666;
        }

        .admin-header {
            margin-bottom: 32px;
        }

        .admin-global-settings {
            margin-bottom: 16px;
        }
        
        .admin-section-title {
            margin-top: 32px;
        }

        .dist-section {
            margin-top: 48px;
        }
        
        .dist-header {
            border-top: 1px solid var(--border); 
            padding-top: 24px;
        }

        .dist-person-name {
            margin: 0;
        }
        
        .dist-copy-btn {
            padding: 6px 12px; 
            font-size: 12px;
        }

        .vault-card-header {
            margin-bottom: 12px;
        }

        .vault-card-title {
            font-size: 1.2rem; 
            margin-bottom: 8px;
        }

        .vault-card-desc {
            font-size: 0.9rem; 
            margin-bottom: 16px;
        }
        
        .vault-card-meta {
            font-size: 0.85rem; 
            color: var(--text-muted); 
            display: flex; 
            align-items: center; 
            gap: 6px;
        }

        .share-name-input {
            border: none; 
            padding: 4px; 
            font-weight: 500; 
            width: 100%;
        }

        .share-value-display {
            font-family: monospace; 
            font-size: 12px; 
            background: #f8fafc; 
            border: none; 
            color: var(--text-muted); 
            width: 100%;
        }

        /* Back Button */
        .back-btn {
            margin-bottom: 16px;
        }

        /* Vault Description (in decrypted view) */
        .vault-description {
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        /* Available Vaults (Main View) */
        #content-list {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-top: 24px;
        }

        .content-item {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        .content-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .content-name {
            font-size: 1.25rem;
            margin-bottom: 8px;
        }

        .content-meta {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .content-desc {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        /* Unlock Modal */
        .unlock-input-row {
            margin-bottom: 16px;
        }

        /* Share Table Container */
        .share-table-wrapper {
            display: flex;
            flex-direction: column;
        }

        /* Status Badges */
        .badge-available {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 5px;
        }

        .badge-pending {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 5px;
        }

        /* Hint Text */
        .hint-text {
            font-style: italic;
            opacity: 0.7;
        }
    </style>
</head>

<body>
    <div class="lang-selector-container lang-selector">
        <select id="lang-select" onchange="ui.setLanguage(this.value)" class="lang-select-input">
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="de">Deutsch</option>
        </select>
    </div>
    <div class="container">
        <!-- Main View Templates -->
        <div id="main-view">
            <div class="card">
                <h1 data-i18n="app.title">Secure Instructions</h1>
                <p data-i18n="app.description">This application allows you to access encrypted content that requires
                    multiple passwords to decrypt. Select a content item below and follow the instructions.</p>
                <div id="main-greeting-container" class="main-greeting-container">
                    <p data-i18n="app.intro">So, you received this file and a password? Here is what to do:</p>
                    <ol class="main-intro-list">
                        <li data-i18n="app.step1">Look at the "Available Contents" list below.</li>
                        <li data-i18n="app.step2">Click "Access Content" on the item you want to open.</li>
                        <li data-i18n="app.step3">Enter the passwords you were given. You need enough different passwords from different people to unlock it.</li>
                    </ol>
                 </div>
                 <button id="main-create-btn" class="btn btn-secondary" onclick="window.location.hash = '#admin'" data-i18n="app.create">Create New Vault</button>
            </div>

            <div class="card">
                <h2 data-i18n="contents.title">Available Contents</h2>
                <div id="content-list"></div>
            </div>
        </div>

        <!-- Decryption View -->
        <div id="decryption-view" class="hidden">
            <div class="card">
                <button class="btn btn-secondary" onclick="showMainView()" data-i18n="common.back">Back</button>
                <h2 id="decrypt-title"></h2>
                <p id="decrypt-description"></p>
                <p class="decrypt-guide-text" data-i18n="decrypt.guide">Enter the password shares you have collected below. The order does not matter.</p>
                <div id="decrypt-messages"></div>

                <div id="password-inputs"></div>
                <button class="btn" onclick="attemptDecryption()" data-i18n="decrypt.button">Decrypt Content</button>
            </div>
        </div>

        <!-- Decrypted Content View -->
        <div id="content-view" class="hidden">
            <div class="card">
                <button class="btn btn-secondary back-btn" onclick="showMainView()" data-i18n="common.back">Back</button>
                <h2 id="content-title"></h2>
                <p id="content-description" class="vault-description"></p>
                <div id="content-text"></div>
                <h3 data-i18n="files.title" class="files-section-title">Files</h3>
                <div id="content-files" class="file-list-container"></div>
                <div id="recovered-keys-container"></div>
            </div>
        </div>

        <!-- Admin Dashboard (Secure Assembler) -->
        <div id="admin-dashboard-view" class="hidden">
            <!-- Header -->
            <div class="admin-header">
                <div>
                    <h2 data-i18n="admin.dashboardTitle">Secure Assembler</h2>
                    <p data-i18n="admin.dashboardSubtitle">Manage content and generate distribution keys.</p>
                </div>
                <div class="admin-actions">
                    <button id="btn-unlock-all" class="btn btn-secondary" onclick="unlockAllVaults()" data-i18n="admin.unlockAll">
                        Unlock All / Enter Keys
                    </button>
                    <button class="btn btn-secondary" onclick="exitAdmin()" data-i18n="admin.exit">
                        Exit Admin
                    </button>

                    <button class="btn btn-success" onclick="downloadSecureFile()" data-i18n="admin.export">
                        Export Secure File
                    </button>
                </div>
            </div>

            <!-- Global Settings Widget -->
            <div class="card">
                <div class="admin-global-settings">
                    <h3 data-i18n="admin.globalGreeting">Global Greeting</h3>
                    <p class="settings-desc" data-i18n="admin.shownToAll">Shown to all recipients.</p>
                </div>
                <div class="greeting-input-group">
                    <div>
                        <label data-i18n="admin.greetingLabel">Greeting Text (Use {names} for auto-list)</label>
                        <input type="text" id="global-greeting-input" data-i18n="admin.greetingPlaceholder" placeholder="Hello {names}, here are your keys..." oninput="updateGlobalGreeting(this.value)">
                    </div>
                </div>
            </div>

            <!-- Vaults Grid -->
            <div>
                <h3 class="admin-section-title" data-i18n="admin.secureVaults">Secure Vaults</h3>
                <div class="dashboard-grid" id="dashboard-vaults-grid">
                    <!-- Add Content Card -->
                    <div class="vault-add-card" onclick="openVaultEditor(null)">
                        <svg class="add-card-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        <span data-i18n="admin.createVaultCard">Create New Vault</span>
                    </div>
                    <!-- Vault items will be rendered here -->
                </div>
            </div>
            
            <!-- Distribution Center -->
            <div class="dist-section">
                  <h3 class="dist-header" data-i18n="admin.distributionCenter">Distribution Center</h3>
                  <p data-i18n="admin.distributionDesc">Copy these messages to send to each person.</p>
                  <div id="distribution-center-list">
                      <!-- Person Cards will go here -->
                  </div>
            </div>
        </div>
    </div>


    <!-- Templates -->
    <template id="tmpl-content-item">
        <div class="content-item">
            <h3 class="content-name"></h3>
            <div class="content-meta"></div>
            <p class="content-desc"></p>
            <button class="btn btn-access" data-i18n="app.access">Access Content</button>
        </div>
    </template>

    <template id="tmpl-admin-content-item">
        <div class="content-item">
            <h3 class="content-name"></h3>
            <div class="content-meta"></div>
            <p class="content-desc"></p>
            <button class="btn btn-edit" data-i18n="common.edit">Edit</button>
            <button class="btn btn-danger btn-delete" data-i18n="common.delete">Delete</button>
        </div>
    </template>

    <template id="tmpl-file-preview">
        <div class="file-item">
            <div class="file-preview-header">
                <span class="file-name-type"></span>
                <span class="file-badge badge"></span>
            </div>
            <div>
                <a class="file-download-link" target="_blank">Download</a>
                <button type="button" class="btn btn-danger file-remove-btn">Remove</button>
            </div>
        </div>
    </template>

    <template id="tmpl-vault-card">
        <div class="vault-card">
            <div class="vault-card-header">
                <span class="badge vault-card-badge"></span>
            </div>
            <h3 class="vault-card-title"></h3>
            <p class="vault-card-desc"></p>
            <div class="vault-card-meta">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span class="vault-card-owners"></span>
            </div>
        </div>
    </template>

    <template id="tmpl-share-row-modal">
        <div class="share-row-modal">
            <span class="share-index"></span>
            <div class="share-cell">
                <input type="text" list="all-share-names" class="share-name-input-modal share-name-input" data-i18n="share.placeholder" placeholder="Person Name (e.g. Alice)">
            </div>
            <div class="share-cell">
                <input type="text" class="share-value-input share-value-display" readonly>
            </div>
            <button class="btn btn-secondary share-copy-btn" data-i18n="common.copy">Copy</button>
        </div>
    </template>
    
    <template id="tmpl-dist-personal">
        <div class="card dist-card">
            <h3 class="dist-person-name"></h3>
            <button class="btn btn-secondary dist-copy-email-btn dist-copy-btn" data-i18n="dist.copyEmail">Copy Email</button>
            <div class="code-block dist-email-text"></div>
        </div>
    </template>
    
    <template id="tmpl-dist-admin">
        <div class="card dist-card dist-card-admin">
             <h3 class="text-main dist-person-name" data-i18n="dist.adminKeys">Admin / Master Keys</h3>
             <button class="btn btn-secondary dist-copy-keys-btn dist-copy-btn" data-i18n="dist.copyKeys">Copy Keys</button>
             <div class="code-block dist-keys-text"></div>
        </div>
    </template>

    <template id="tmpl-decrypted-file">
        <a class="file-list-item" target="_blank">
            <div class="file-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
            </div>
            <div class="file-info">
                <span class="file-name"></span>
                <span class="file-meta"></span>
            </div>
            <div class="file-action-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </div>
        </a>
    </template>

    <template id="tmpl-recovered-key">
        <div class="share-row-read-only">
            <span class="share-index"></span>
            <div class="share-cell">
                <span class="share-name share-name-label"></span>
            </div>
            <div class="share-cell">
                <code class="share-value share-value-code"></code>
            </div>
            <button class="btn btn-secondary share-copy-btn" data-i18n="common.copy">Copy</button>
        </div>
    </template>

    <script>/*! secrets.js-grempe 2019-09-07 */

!function(t,e){"use strict";"function"==typeof define&&define.amd?define([],function(){return t.secrets=e()}):"object"==typeof exports?module.exports=e(require("crypto")):t.secrets=e(t.crypto)}(this,function(n){"use strict";var u,b,i,a,s;function h(){u={bits:8,radix:16,minBits:3,maxBits:20,bytesPerChar:2,maxBytesPerChar:6,primitivePolynomials:[null,null,1,3,3,5,3,3,29,17,9,5,83,27,43,3,45,9,39,39,9,5,3,33,27,9,71,39,9,5,83]},b={},i=new Array(1024).join("0"),a=!0,s=["nodeCryptoRandomBytes","browserCryptoGetRandomValues","testRandom"]}function f(){return!(!b||!b.rng||"function"!=typeof b.rng)}function g(t,e){var r;if(0===e||1===e)return t;if(e&&1024<e)throw new Error("Padding must be multiples of no larger than 1024 bits.");return e=e||b.bits,t&&(r=t.length%e),r?(i+t).slice(-(e-r+t.length)):t}function c(t){var e,r,n="";for(r=t.length-1;0<=r;r--){if(e=parseInt(t[r],16),isNaN(e))throw new Error("Invalid hex character.");n=g(e.toString(2),4)+n}return n}function m(t){var e,r,n="";for(r=(t=g(t,4)).length;4<=r;r-=4){if(e=parseInt(t.slice(r-4,r),2),isNaN(e))throw new Error("Invalid binary character.");n=e.toString(16)+n}return n}function o(){return!(!n||"object"!=typeof n||"function"!=typeof n.getRandomValues&&"object"!=typeof n.getRandomValues||"function"!=typeof Uint32Array&&"object"!=typeof Uint32Array)}function l(){return"object"==typeof n&&"function"==typeof n.randomBytes}function p(t){function a(t,e,r,n){var i,a=0,o="";for(e&&(i=e.length-1);a<i||o.length<t;)o+=g(Math.abs(parseInt(e[a],r)).toString(2),n),a++;return((o=o.substr(-t)).match(/0/g)||[]).length===o.length?null:o}function e(t){var e,r=null;for(16,4,e=Math.ceil(t/8);null===r;)r=a(t,n.randomBytes(e).toString("hex"),16,4);return r}function r(t){var e,r=null;for(10,32,e=Math.ceil(t/32);null===r;)r=a(t,n.getRandomValues(new Uint32Array(e)),10,32);return r}return t&&"testRandom"===t?(b.typeCSPRNG=t,function(t){var e,r,n=null;r=Math.ceil(t/32),e=new Uint32Array(r);for(var i=0;i<e.length;i++)e[i]=123456789;for(;null===n;)n=a(t,e,10,32);return n}):t&&"nodeCryptoRandomBytes"===t?(b.typeCSPRNG=t,e):t&&"browserCryptoGetRandomValues"===t?(b.typeCSPRNG=t,r):l()?(b.typeCSPRNG="nodeCryptoRandomBytes",e):o()?(b.typeCSPRNG="browserCryptoGetRandomValues",r):void 0}function d(t,e){var r,n=[];for(e&&(t=g(t,e)),r=t.length;r>b.bits;r-=b.bits)n.push(parseInt(t.slice(r-b.bits,r),2));return n.push(parseInt(t.slice(0,r),2)),n}function w(t,e){var r,n=b.logs[t],i=0;for(r=e.length-1;0<=r;r--)i=0!==i?b.exps[(n+b.logs[i])%b.maxShares]^e[r]:e[r];return i}function y(t,e,r){var n,i,a,o,s=0;for(a=0,n=e.length;a<n;a++)if(r[a]){for(i=b.logs[r[a]],o=0;o<n;o++)if(a!==o){if(t===e[o]){i=-1;break}i=(i+b.logs[t^e[o]]-b.logs[e[a]^e[o]]+b.maxShares)%b.maxShares}s=-1===i?s:s^b.exps[i]}return s}function x(t,e,r){var n,i,a=[],o=[t];for(n=1;n<r;n++)o[n]=parseInt(b.rng(b.bits),2);for(i=e+(n=1);n<i;n++)a[n-1]={x:n,y:w(n,o)};return a}function v(t,e,r){var n,i,a,o;if(e=parseInt(e,b.radix),n=(t=parseInt(t,10)||b.bits).toString(36).toUpperCase(),o=(a=Math.pow(2,t)-1).toString(b.radix).length,i=g(e.toString(b.radix),o),"number"!=typeof e||e%1!=0||e<1||a<e)throw new Error("Share id must be an integer between 1 and "+a+", inclusive.");return n+i+r}var t={init:function(t,e){var r,n,i=[],a=[],o=1;if(h(),t&&("number"!=typeof t||t%1!=0||t<u.minBits||t>u.maxBits))throw new Error("Number of bits must be an integer between "+u.minBits+" and "+u.maxBits+", inclusive.");if(e&&-1===s.indexOf(e))throw new Error("Invalid RNG type argument : '"+e+"'");for(b.radix=u.radix,b.bits=t||u.bits,b.size=Math.pow(2,b.bits),b.maxShares=b.size-1,r=u.primitivePolynomials[b.bits],n=0;n<b.size;n++)i[a[n]=o]=n,(o<<=1)>=b.size&&(o^=r,o&=b.maxShares);if(b.logs=i,b.exps=a,e&&this.setRNG(e),f()||this.setRNG(),!(f()&&b.bits&&b.size&&b.maxShares&&b.logs&&b.exps&&b.logs.length===b.size&&b.exps.length===b.size))throw new Error("Initialization failed.")},combine:function(t,e){var r,n,i,a,o,s,h,u="",f=[],l=[];for(e=e||0,r=0,i=t.length;r<i;r++){if(s=this.extractShareComponents(t[r]),void 0===o)o=s.bits;else if(s.bits!==o)throw new Error("Mismatched shares: Different bit settings.");if(b.bits!==o&&this.init(o),-1===f.indexOf(s.id))for(f.push(s.id),n=0,a=(h=d(c(s.data))).length;n<a;n++)l[n]=l[n]||[],l[n][f.length-1]=h[n]}for(r=0,i=l.length;r<i;r++)u=g(y(e,f,l[r]).toString(2))+u;return m(1<=e?u:u.slice(u.indexOf("1")+1))},getConfig:function(){var t={};return t.radix=b.radix,t.bits=b.bits,t.maxShares=b.maxShares,t.hasCSPRNG=f(),t.typeCSPRNG=b.typeCSPRNG,t},extractShareComponents:function(t){var e,r,n,i,a,o={};if((e=parseInt(t.substr(0,1),36))&&("number"!=typeof e||e%1!=0||e<u.minBits||e>u.maxBits))throw new Error("Invalid share : Number of bits must be an integer between "+u.minBits+" and "+u.maxBits+", inclusive.");if(i=Math.pow(2,e)-1,n=(Math.pow(2,e)-1).toString(b.radix).length,(a=new RegExp("^([a-kA-K3-9]{1})([a-fA-F0-9]{"+n+"})([a-fA-F0-9]+)$").exec(t))&&(r=parseInt(a[2],b.radix)),"number"!=typeof r||r%1!=0||r<1||i<r)throw new Error("Invalid share : Share id must be an integer between 1 and "+b.maxShares+", inclusive.");if(a&&a[3])return o.bits=e,o.id=r,o.data=a[3],o;throw new Error("The share data provided is invalid : "+t)},setRNG:function(t){var e="Random number generator is invalid ",r=" Supply an CSPRNG of the form function(bits){} that returns a string containing 'bits' number of random 1's and 0's.";if(t&&"string"==typeof t&&-1===s.indexOf(t))throw new Error("Invalid RNG type argument : '"+t+"'");if((t=t||p())&&"string"==typeof t&&(t=p(t)),a){if(t&&"function"!=typeof t)throw new Error(e+"(Not a function)."+r);if(t&&"string"!=typeof t(b.bits))throw new Error(e+"(Output is not a string)."+r);if(t&&!parseInt(t(b.bits),2))throw new Error(e+"(Binary string output not parseable to an Integer)."+r);if(t&&t(b.bits).length>b.bits)throw new Error(e+"(Output length is greater than config.bits)."+r);if(t&&t(b.bits).length<b.bits)throw new Error(e+"(Output length is less than config.bits)."+r)}return b.rng=t,!0},str2hex:function(t,e){var r,n,i,a,o,s,h="";if("string"!=typeof t)throw new Error("Input must be a character string.");if("number"!=typeof(e=e||u.bytesPerChar)||e<1||e>u.maxBytesPerChar||e%1!=0)throw new Error("Bytes per character must be an integer between 1 and "+u.maxBytesPerChar+", inclusive.");for(r=2*e,n=Math.pow(16,r)-1,o=0,s=t.length;o<s;o++){if(a=t[o].charCodeAt(),isNaN(a))throw new Error("Invalid character: "+t[o]);if(n<a)throw i=Math.ceil(Math.log(a+1)/Math.log(256)),new Error("Invalid character code ("+a+"). Maximum allowable is 256^bytes-1 ("+n+"). To convert this character, use at least "+i+" bytes.");h=g(a.toString(16),r)+h}return h},hex2str:function(t,e){var r,n,i,a="";if("string"!=typeof t)throw new Error("Input must be a hexadecimal string.");if("number"!=typeof(e=e||u.bytesPerChar)||e%1!=0||e<1||e>u.maxBytesPerChar)throw new Error("Bytes per character must be an integer between 1 and "+u.maxBytesPerChar+", inclusive.");for(n=0,i=(t=g(t,r=2*e)).length;n<i;n+=r)a=String.fromCharCode(parseInt(t.slice(n,n+r),16))+a;return a},random:function(t){if("number"!=typeof t||t%1!=0||t<2||65536<t)throw new Error("Number of bits must be an Integer between 1 and 65536.");return m(b.rng(t))},share:function(t,e,r,n){var i,a,o,s,h,u=new Array(e),f=new Array(e);if(n=n||128,"string"!=typeof t)throw new Error("Secret must be a string.");if("number"!=typeof e||e%1!=0||e<2)throw new Error("Number of shares must be an integer between 2 and 2^bits-1 ("+b.maxShares+"), inclusive.");if(e>b.maxShares)throw i=Math.ceil(Math.log(e+1)/Math.LN2),new Error("Number of shares must be an integer between 2 and 2^bits-1 ("+b.maxShares+"), inclusive. To create "+e+" shares, use at least "+i+" bits.");if("number"!=typeof r||r%1!=0||r<2)throw new Error("Threshold number of shares must be an integer between 2 and 2^bits-1 ("+b.maxShares+"), inclusive.");if(r>b.maxShares)throw i=Math.ceil(Math.log(r+1)/Math.LN2),new Error("Threshold number of shares must be an integer between 2 and 2^bits-1 ("+b.maxShares+"), inclusive.  To use a threshold of "+r+", use at least "+i+" bits.");if(e<r)throw new Error("Threshold number of shares was "+r+" but must be less than or equal to the "+e+" shares specified as the total to generate.");if("number"!=typeof n||n%1!=0||n<0||1024<n)throw new Error("Zero-pad length must be an integer between 0 and 1024 inclusive.");for(o=0,h=(t=d(t="1"+c(t),n)).length;o<h;o++)for(a=x(t[o],e,r),s=0;s<e;s++)u[s]=u[s]||a[s].x.toString(b.radix),f[s]=g(a[s].y.toString(2))+(f[s]||"");for(o=0;o<e;o++)u[o]=v(b.bits,u[o],m(f[o]));return u},newShare:function(t,e){var r;if(t&&"string"==typeof t&&(t=parseInt(t,b.radix)),r=t.toString(b.radix),t&&r&&e&&e[0])return v(this.extractShareComponents(e[0]).bits,r,this.combine(e,t));throw new Error("Invalid 'id' or 'shares' Array argument to newShare().")},_reset:h,_padLeft:g,_hex2bin:c,_bin2hex:m,_hasCryptoGetRandomValues:o,_hasCryptoRandomBytes:l,_getRNG:p,_isSetRNG:f,_splitNumStringToIntArray:d,_horner:w,_lagrange:y,_getShares:x,_constructPublicShareString:v};return t.init(),t});</script>

    <script>
        // Application State
        let appData = {
            contents: [],
            settings: {
                greeting: '' // Default greeting override
            },
            currentContent: null,
            isAdmin: false,
            editingId: null
        };

        // Store initial HTML for clean exports
        let initialHTML = '';

        // Internationalization
        const i18n = {
            en: {
                'app.title': 'Secure Instructions',
                'app.description': 'This application allows you to access encrypted content that requires multiple passwords to decrypt. Select a content item below and follow the instructions.',
                'contents.title': 'Available Contents',
                'decrypt.button': 'Decrypt Content',
                'files.title': 'Files',
                'common.back': 'Back',
                'common.cancel': 'Cancel',
                'admin.title': 'Admin Interface',
                'admin.listContents': 'List Contents',
                'admin.createContent': 'Create Content',
                'admin.globalSettings': 'Global Settings',
                'admin.exit': 'Exit Admin',
                'admin.contentList': 'Content Management',
                'admin.createNew': 'Create New Content',
                'admin.step1': 'Step 1: Basic Information',
                'admin.contentName': 'Content Name:',
                'admin.description': 'Description:',
                'admin.totalShares': 'Total Number of Password Shares:',
                'admin.requiredShares': 'Required Shares to Decrypt:',
                'admin.generateShares': 'Generate Shares',
                'admin.step2': 'Step 2: Generated Shares',
                'admin.masterKey': 'Master Key (save this securely):',
                'admin.proceedToContent': 'Proceed to Content',
                'admin.step3': 'Step 3: Content',
                'admin.instructionText': 'Instruction Text (encrypted):',
                'admin.uploadFiles': 'Upload Files:',
                'admin.save': 'Save Content',
                'app.intro': 'So, you received this file and a password? Here is what to do:',
                'app.step1': 'Look at the \"Available Contents\" list below.',
                'app.step2': 'Click \"Access Content\" on the item you want to open.',
                'app.step3': 'Enter the passwords you were given. You need enough different passwords from different people to unlock it.',
                'app.create': 'Create New Vault',
                'decrypt.guide': 'Enter the password shares you have collected below. The order does not matter.',
                'admin.settings.title': 'Global Settings',
                'admin.settings.greeting': 'Custom Greeting Text:',
                'admin.settings.greetingPlaceholder': 'Leave empty to use the default greeting...',
                'admin.settings.save': 'Save Settings',
                'app.access': 'Access Content',
                'dist.copyEmail': 'Copy Email',
                'dist.copyKeys': 'Copy Keys',
                'dist.adminKeys': 'Admin / Master Keys',
                'dist.to': 'To:',
                'dist.clickCopy': '(click Copy to get full text)',
                'share.placeholder': 'Person Name (e.g. Alice)',
                'dist.noPlan': 'No distribution plans generated yet.',
                'dist.createVaults': 'Create vaults and assign names to see your distribution list here.',
                'common.edit': 'Edit',
                'common.delete': 'Delete',
                'content.requirements': 'Requires {req} of {total} passwords',
                'prompt.enterMasterKey': 'Enter master key to edit this content:',
                'error.invalidMasterKey': 'Invalid master key or corrupted content',
                'error.nameRequired': 'Name and Secret Message are required.',
                'error.enterPasswords': 'Please enter all required passwords',
                'decrypt.viewKeys': 'View Original Keys (Restored)',
                'decrypt.noFiles': 'No files attached',
                'admin.dashboardTitle': 'Secure Assembler',
                'admin.dashboardSubtitle': 'Manage content and generate distribution keys.',
                'admin.unlockAll': 'Unlock All / Enter Keys',
                'admin.export': 'Export Secure File',
                'admin.globalGreeting': 'Global Greeting',
                'admin.shownToAll': 'Shown to all recipients.',
                'admin.greetingLabel': 'Greeting Text (Use {names} for auto-list)',
                'admin.secureVaults': 'Secure Vaults',
                'admin.createVaultCard': 'Create New Vault',
                'admin.distributionCenter': 'Distribution Center',
                'admin.distributionDesc': 'Copy these messages to send to each person.',
                'unlock.title': 'Enter Master Keys',
                'unlock.description': 'Enter the master key for each vault to generate distribution messages.',
                'unlock.confirm': 'Unlock All',
                'unlock.placeholder': 'Enter Master Key',
                'editor.titleEdit': 'Edit Vault',
                'editor.titleNew': 'New Vault',
                'editor.vaultName': 'Vault Name',
                'editor.vaultDesc': 'Description (Visible to public)',
                'editor.secretMessage': 'Secret Message',
                'editor.secretPlaceholder': 'Type your secret instructions here...',
                'editor.files': 'Files (Drag & Drop or Click)',
                'editor.shareConfig': 'Share Configuration',
                'editor.totalShares': 'Total Shares',
                'editor.requiredShares': 'Required Shares',
                'editor.masterKey': 'Master Key',
                'editor.generatedShares': 'Generated Shares',
                'editor.regenerate': 'Regenerate',
                'editor.save': 'Save Vault',
                'editor.delete': 'Delete Vault',
                'error.noContent': 'No content to save.',
                'success.generated': 'Updated file generated and downloaded!',
                'error.adminHttps': 'Admin interface is only available when served via HTTP/HTTPS server...',
                'confirm.deleteVault': 'Delete this vault?',
                'confirm.alreadyUnlocked': 'All vaults are already unlocked. Do you want to re-enter keys?',
                'error.noVaults': 'No vaults to unlock.',
                'app.noContent': 'No content available.',
                'dist.noContent': 'No content to distribute.',
                'dist.unlockHint': 'Use "Unlock All" above to enter master keys for all vaults to generate distribution messages.',
                'dist.locked': 'Locked (Enter Master Key to view distribution info)',
                'dist.caution': '[CAUTION: This text contains the SECRET KEYS for "{name}". Handle with care!]',
                'dist.step1': 'Download the HTML file and send it as an attachment to everyone.',
                'dist.step2': 'Then, send each person their unique key separately.',
                'dist.noShares': 'No shares found in this content.',
                'dist.keyIntro': 'YOUR UNIQUE ACCESS KEY:',
                'dist.keysIntro': 'Here are your unique keys:',
                'dist.keepSafe': 'Keep these safe! You will need them to unlock the files.',
                'dist.defaultGreeting': 'Here is the Secure Vault file.',
                'dist.adminKeysTitle': 'ADMIN MASTER KEYS (KEEP SAFE!)',
                'editor.vaultNamePlaceholder': 'e.g. Bank Accounts',
                'editor.vaultDescPlaceholder': 'Details about what is inside...',
                'admin.greetingPlaceholder': 'Hello {names}, here are your keys...',
                'editor.dropFiles': 'Click or Drop files here',
                'common.copy': 'Copy',
                'common.copied': 'Copied!',
                'decrypt.keyHolders': 'Key Holders:',
                'decrypt.enterShareKey': 'Enter any valid share key',
                'decrypt.shareLabel': 'Share #{n}:',
                'admin.sharesBadge': 'Shares',
                'admin.noOwners': 'No owners assigned'
            },
            fr: {
                'app.title': 'Instructions Sécurisées',
                'app.description': 'Cette application vous permet d\'accéder à du contenu crypté nécessitant plusieurs mots de passe pour être déchiffré. Sélectionnez un élément ci-dessous et suivez les instructions.',
                'contents.title': 'Contenus Disponibles',
                'decrypt.button': 'Déchiffrer le Contenu',
                'files.title': 'Fichiers',
                'common.back': 'Retour',
                'common.cancel': 'Annuler',
                'admin.title': 'Interface Administrateur',
                'admin.listContents': 'Liste des Contenus',
                'admin.createContent': 'Créer un Contenu',
                'admin.globalSettings': 'Paramètres Globaux',
                'admin.exit': 'Quitter l\'Admin',
                'admin.contentList': 'Gestion de Contenu',
                'admin.createNew': 'Créer Nouveau Contenu',
                'admin.step1': 'Étape 1: Informations de Base',
                'admin.contentName': 'Nom du Contenu:',
                'admin.description': 'Description:',
                'admin.totalShares': 'Nombre Total de Parts:',
                'admin.requiredShares': 'Parts Requises pour Déchiffrer:',
                'admin.generateShares': 'Générer les Parts',
                'admin.step2': 'Étape 2: Parts Générées',
                'admin.masterKey': 'Clé Maître (sauvegardez-la en lieu sûr):',
                'admin.proceedToContent': 'Procéder au Contenu',
                'admin.step3': 'Étape 3: Contenu',
                'admin.instructionText': 'Texte d\'Instruction (chiffré):',
                'admin.uploadFiles': 'Télécharger des Fichiers:',
                'admin.save': 'Sauvegarder le Contenu',
                'app.intro': 'Vous avez reçu ce fichier et un mot de passe ? Voici ce qu\'il faut faire :',
                'app.step1': 'Regardez la liste "Contenus Disponibles" ci-dessous.',
                'app.step2': 'Cliquez sur "Accéder au Contenu" sur l\'élément que vous voulez ouvrir.',
                'app.step3': 'Entrez les mots de passe qui vous ont été donnés. Vous avez besoin de suffisamment de mots de passe différents de personnes différentes.',
                'app.create': 'Créer un Nouveau Coffre-fort',
                'decrypt.guide': 'Entrez les parts de mot de passe que vous avez collectées ci-dessous. L\'ordre n\'a pas d\'importance.',
                'admin.settings.title': 'Paramètres Globaux',
                'admin.settings.greeting': 'Texte d\'Accueil Personnalisé :',
                'admin.settings.greetingPlaceholder': 'Laisser vide pour utiliser le texte par défaut...',
                'admin.settings.save': 'Sauvegarder les Paramètres',
                'app.access': 'Accéder au Contenu',
                'dist.copyEmail': 'Copier l\'Email',
                'dist.copyKeys': 'Copier les Clés',
                'dist.adminKeys': 'Clés Maître / Admin',
                'dist.to': 'À:',
                'dist.clickCopy': '(cliquer sur Copier pour voir tout)',
                'share.placeholder': 'Nom de la Personne (ex: Alice)',
                'dist.noPlan': 'Aucun plan de distribution généré.',
                'dist.createVaults': 'Créez des coffres-forts et assignez des noms pour voir votre liste ici.',
                'common.edit': 'Éditer',
                'common.delete': 'Supprimer',
                'content.requirements': 'Nécessite {req} sur {total} mots de passe',
                'prompt.enterMasterKey': 'Entrez la clé maître pour éditer ce contenu :',
                'error.invalidMasterKey': 'Clé maître invalide ou contenu corrompu',
                'error.nameRequired': 'Le nom et le message secret sont requis.',
                'error.enterPasswords': 'Veuillez entrer tous les mots de passe requis',
                'decrypt.viewKeys': 'Voir les Clés Originales (Restaurées)',
                'decrypt.noFiles': 'Aucun fichier joint',
                'admin.dashboardTitle': 'Assembleur Sécurisé',
                'admin.dashboardSubtitle': 'Gérer le contenu et générer les clés de distribution.',
                'admin.unlockAll': 'Tout Déverrouiller / Entrer Clés',
                'admin.export': 'Exporter le Fichier Sécurisé',
                'admin.globalGreeting': 'Salutation Globale',
                'admin.shownToAll': 'Affiché à tous les destinataires.',
                'admin.greetingLabel': 'Texte de Salutation (Utilisez {names} pour la liste auto)',
                'admin.secureVaults': 'Coffres-forts Sécurisés',
                'admin.createVaultCard': 'Créer un Nouveau Coffre',
                'admin.distributionCenter': 'Centre de Distribution',
                'admin.distributionDesc': 'Copiez ces messages pour les envoyer à chaque personne.',
                'unlock.title': 'Entrer les Clés Maîtres',
                'unlock.description': 'Entrez la clé maître pour chaque coffre pour générer les messages.',
                'unlock.confirm': 'Tout Déverrouiller',
                'unlock.placeholder': 'Entrer la Clé Maître',
                'editor.titleEdit': 'Éditer le Coffre',
                'editor.titleNew': 'Nouveau Coffre',
                'editor.vaultName': 'Nom du Coffre',
                'editor.vaultDesc': 'Description (Visible au public)',
                'editor.secretMessage': 'Message Secret',
                'editor.secretPlaceholder': 'Tapez vos instructions secrètes ici...',
                'editor.files': 'Fichiers (Glisser-déposer ou Clic)',
                'editor.shareConfig': 'Configuration du Partage',
                'editor.totalShares': 'Total des Parts',
                'editor.requiredShares': 'Parts Requises',
                'editor.masterKey': 'Clé Maître',
                'editor.generatedShares': 'Parts Générées',
                'editor.regenerate': 'Régénérer',
                'editor.save': 'Sauvegarder le Coffre',
                'editor.delete': 'Supprimer le Coffre',
                'error.noContent': 'Aucun contenu à sauvegarder.',
                'success.generated': 'Fichier mis à jour généré et téléchargé !',
                'error.adminHttps': 'L\'interface admin n\'est disponible que via serveur HTTP/HTTPS...',
                'confirm.deleteVault': 'Supprimer ce coffre ?',
                'confirm.alreadyUnlocked': 'Tout est déjà déverrouillé. Voulez-vous ré-entrer les clés ?',
                'error.noVaults': 'Aucun coffre à déverrouiller.',
                'app.noContent': 'Aucun contenu disponible.',
                'dist.noContent': 'Aucun contenu à distribuer.',
                'dist.unlockHint': 'Utilisez "Tout Déverrouiller" ci-dessus pour entrer les clés pour tous les coffres.',
                'dist.locked': 'Verrouillé (Entrez la Clé Maître pour voir les infos)',
                'dist.caution': '[ATTENTION: Ce texte contient les CLÉS SECRÈTES pour "{name}". Manipulez avec précaution !]',
                'dist.step1': 'Téléchargez le fichier HTML et envoyez-le en pièce jointe à tout le monde.',
                'dist.step2': 'Ensuite, envoyez à chaque personne sa clé unique séparément.',
                'dist.noShares': 'Aucune part trouvée dans ce contenu.',
                'dist.keyIntro': 'VOTRE CLÉ D\'ACCÈS UNIQUE :',
                'dist.keysIntro': 'Voici vos clés uniques :',
                'dist.keepSafe': 'Gardez-les en sécurité ! Vous en aurez besoin pour déverrouiller les fichiers.',
                'dist.defaultGreeting': 'Voici le fichier du Coffre Sécurisé.',
                'dist.adminKeysTitle': 'CLÉS MAÎTRES ADMIN (GARDER EN SÉCURITÉ !)',
                'editor.vaultNamePlaceholder': 'ex: Comptes Bancaires',
                'editor.vaultDescPlaceholder': 'Détails sur ce qui est à l\'intérieur...',
                'admin.greetingPlaceholder': 'Bonjour {names}, voici vos clés...',
                'editor.dropFiles': 'Cliquez ou Glissez-déposez des fichiers ici',
                'common.copy': 'Copier',
                'common.copied': 'Copié !',
                'decrypt.keyHolders': 'Détenteurs de Clés :',
                'decrypt.enterShareKey': 'Entrez une clé de partage valide',
                'decrypt.shareLabel': 'Part #{n} :',
                'admin.sharesBadge': 'Parts',
                'admin.noOwners': 'Aucun propriétaire'
            },
            de: {
                'app.title': 'Sichere Anweisungen',
                'app.description': 'Diese Anwendung ermöglicht den Zugriff auf verschlüsselte Inhalte, die mehrere Passwörter zum Entschlüsseln erfordern. Wählen Sie unten einen Inhalt aus und folgen Sie den Anweisungen.',
                'contents.title': 'Verfügbare Inhalte',
                'decrypt.button': 'Inhalt Entschlüsseln',
                'files.title': 'Dateien',
                'common.back': 'Zurück',
                'common.cancel': 'Abbrechen',
                'admin.title': 'Admin-Oberfläche',
                'admin.listContents': 'Inhalte Auflisten',
                'admin.createContent': 'Inhalt Erstellen',
                'admin.globalSettings': 'Globale Einstellungen',
                'admin.exit': 'Admin Beenden',
                'admin.contentList': 'Inhaltsverwaltung',
                'admin.createNew': 'Neuen Inhalt Erstellen',
                'admin.step1': 'Schritt 1: Basis-Informationen',
                'admin.contentName': 'Inhaltsname:',
                'admin.description': 'Beschreibung:',
                'admin.totalShares': 'Gesamtzahl der Passwort-Anteile:',
                'admin.requiredShares': 'Erforderliche Anteile zum Entschlüsseln:',
                'admin.generateShares': 'Anteile Generieren',
                'admin.step2': 'Schritt 2: Generierte Anteile',
                'admin.masterKey': 'Hauptschlüssel (sicher aufbewahren):',
                'admin.proceedToContent': 'Weiter zum Inhalt',
                'admin.step3': 'Schritt 3: Inhalt',
                'admin.instructionText': 'Anweisungstext (verschlüsselt):',
                'admin.uploadFiles': 'Dateien Hochladen:',
                'admin.save': 'Inhalt Speichern',
                'app.intro': 'Sie haben diese Datei und ein Passwort erhalten? Hier ist, was zu tun ist:',
                'app.step1': 'Sehen Sie sich die Liste \"Verf\u00fcgbare Inhalte\" unten an.',
                'app.step2': 'Klicken Sie auf \"Inhalt Zugreifen\" bei dem Eintrag, den Sie \u00f6ffnen m\u00f6chten.',
                'app.step3': 'Geben Sie die Passw\u00f6rter ein, die Sie erhalten haben. Sie ben\u00f6tigen gen\u00fcgend verschiedene Passw\u00f6rter von verschiedenen Personen.',
                'app.create': 'Neuen Tresor Erstellen',
                'decrypt.guide': 'Geben Sie unten die gesammelten Passwort-Anteile ein. Die Reihenfolge ist egal.',
                'admin.settings.title': 'Globale Einstellungen',
                'admin.settings.greeting': 'Benutzerdefinierter Begrüßungstext:',
                'admin.settings.greetingPlaceholder': 'Leer lassen für Standardbegrüßung...',
                'admin.settings.save': 'Einstellungen Speichern',
                'app.access': 'Zugriff auf Inhalt',
                'dist.copyEmail': 'E-Mail Kopieren',
                'dist.copyKeys': 'Schlüssel Kopieren',
                'dist.adminKeys': 'Admin / Hauptschlüssel',
                'dist.to': 'An:',
                'dist.clickCopy': '(Kopieren klicken für vollen Text)',
                'share.placeholder': 'Name der Person (z.B. Alice)',
                'dist.noPlan': 'Noch keine Verteilungspläne generiert.',
                'dist.createVaults': 'Erstellen Sie Tresore und weisen Sie Namen zu, um Ihre Liste hier zu sehen.',
                'common.edit': 'Bearbeiten',
                'common.delete': 'Löschen',
                'content.requirements': 'Erfordert {req} von {total} Passwörtern',
                'prompt.enterMasterKey': 'Geben Sie den Hauptschlüssel ein, um diesen Inhalt zu bearbeiten:',
                'error.invalidMasterKey': 'Ungültiger Hauptschlüssel oder beschädigter Inhalt',
                'error.nameRequired': 'Name und geheime Nachricht sind erforderlich.',
                'error.enterPasswords': 'Bitte geben Sie alle erforderlichen Passwörter ein',
                'decrypt.viewKeys': 'Originalschlüssel anzeigen (Wiederhergestellt)',
                'decrypt.noFiles': 'Keine Dateien angehängt',
                'admin.dashboardTitle': 'Sicherer Assembler',
                'admin.dashboardSubtitle': 'Inhalte verwalten und Verteilungsschlüssel generieren.',
                'admin.unlockAll': 'Alles Entsperren / Schlüssel eingeben',
                'admin.export': 'Sichere Datei exportieren',
                'admin.globalGreeting': 'Globale Begrüßung',
                'admin.shownToAll': 'Allen Empfängern angezeigt.',
                'admin.greetingLabel': 'Begrüßungstext (Verwenden Sie {names} für Auto-Liste)',
                'admin.secureVaults': 'Sichere Tresore',
                'admin.createVaultCard': 'Neuen Tresor erstellen',
                'admin.distributionCenter': 'Verteilungszentrum',
                'admin.distributionDesc': 'Kopieren Sie diese Nachrichten, um sie an jede Person zu senden.',
                'unlock.title': 'Hauptschlüssel eingeben',
                'unlock.description': 'Geben Sie den Hauptschlüssel für jeden Tresor ein, um Verteilungsnachrichten zu generieren.',
                'unlock.confirm': 'Alles Entsperren',
                'unlock.placeholder': 'Hauptschlüssel eingeben',
                'editor.titleEdit': 'Tresor bearbeiten',
                'editor.titleNew': 'Neuer Tresor',
                'editor.vaultName': 'Tresorname',
                'editor.vaultDesc': 'Beschreibung (öffentlich sichtbar)',
                'editor.secretMessage': 'Geheime Nachricht',
                'editor.secretPlaceholder': 'Geben Sie Ihre geheimen Anweisungen hier ein...',
                'editor.files': 'Dateien (Drag & Drop oder Klick)',
                'editor.shareConfig': 'Freigabe-Konfiguration',
                'editor.totalShares': 'Gesamte Anteile',
                'editor.requiredShares': 'Erforderliche Anteile',
                'editor.masterKey': 'Hauptschlüssel',
                'editor.generatedShares': 'Generierte Anteile',
                'editor.regenerate': 'Regenerieren',
                'editor.save': 'Tresor speichern',
                'editor.delete': 'Tresor löschen',
                'error.noContent': 'Kein Inhalt zum Speichern.',
                'success.generated': 'Aktualisierte Datei erstellt und heruntergeladen!',
                'error.adminHttps': 'Admin-Interface ist nur über HTTP/HTTPS-Server verfügbar...',
                'confirm.deleteVault': 'Diesen Tresor löschen?',
                'confirm.alreadyUnlocked': 'Alle Tresore sind bereits entsperrt. Möchten Sie die Schlüssel erneut eingeben?',
                'error.noVaults': 'Keine Tresore zum Entsperren.',
                'app.noContent': 'Kein Inhalt verfügbar.',
                'dist.noContent': 'Kein Inhalt zum Verteilen.',
                'dist.unlockHint': 'Verwenden Sie "Alles Entsperren" oben, um Verteilungsnachrichten zu generieren.',
                'dist.locked': 'Gesperrt (Hauptschlüssel eingeben, um Infos zu sehen)',
                'dist.caution': '[ACHTUNG: Dieser Text enthält die GEHEIMEN SCHLÜSSEL für "{name}". Vorsichtig behandeln!]',
                'dist.step1': 'Laden Sie die HTML-Datei herunter und senden Sie sie als Anhang an alle.',
                'dist.step2': 'Senden Sie dann jeder Person ihren einzigartigen Schlüssel separat.',
                'dist.noShares': 'Keine Anteile in diesem Inhalt gefunden.',
                'dist.keyIntro': 'IHR EINZIGARTIGER ZUGANGSSCHLÜSSEL:',
                'dist.keysIntro': 'Hier sind Ihre einzigartigen Schlüssel:',
                'dist.keepSafe': 'Bewahren Sie diese sicher auf! Sie werden benötigt, um die Dateien zu entsperren.',
                'dist.defaultGreeting': 'Hier ist die sichere Tresor-Datei.',
                'dist.adminKeysTitle': 'ADMIN-HAUPTSCHLÜSSEL (SICHER AUFBEWAHREN!)',
                'editor.vaultNamePlaceholder': 'z.B. Bankkonten',
                'editor.vaultDescPlaceholder': 'Details über den Inhalt...',
                'admin.greetingPlaceholder': 'Hallo {names}, hier sind eure Schlüssel...',
                'editor.dropFiles': 'Dateien hier klicken oder ablegen',
                'common.copy': 'Kopieren',
                'common.copied': 'Kopiert!',
                'decrypt.keyHolders': 'Schlüsselinhaber:',
                'decrypt.enterShareKey': 'Geben Sie einen gültigen Teil-Schlüssel ein',
                'decrypt.shareLabel': 'Anteil #{n}:',
                'admin.sharesBadge': 'Anteile',
                'admin.noOwners': 'Keine Eigentümer'
            }
        };

        // Crypto utilities
        const crypto = {
            // Convert hex string to bytes
            hexToBytes(hex) {
                const bytes = new Uint8Array(hex.length / 2);
                for (let i = 0; i < hex.length; i += 2) {
                    bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
                }
                return bytes;
            },

            // Convert bytes to hex string
            bytesToHex(bytes) {
                return Array.from(bytes)
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            },

            // Convert bytes to base64
            bytesToBase64(bytes) {
                // Process in chunks to avoid argument limits
                const chunkSize = 1024;
                const chunks = [];
                for (let i = 0; i < bytes.length; i += chunkSize) {
                    const chunk = bytes.subarray(i, i + chunkSize);
                    chunks.push(String.fromCharCode(...chunk));
                }
                return btoa(chunks.join(''));
            },

            // Convert base64 to bytes
            base64ToBytes(base64) {
                const binary_string = window.atob(base64);
                const len = binary_string.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binary_string.charCodeAt(i);
                }
                return bytes;
            },

            // Generate random bytes
            randomBytes(length) {
                return window.crypto.getRandomValues(new Uint8Array(length));
            },

            // Generate AES key
            async generateKey() {
                const key = await window.crypto.subtle.generateKey(
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );
                const exported = await window.crypto.subtle.exportKey('raw', key);
                return new Uint8Array(exported);
            },

            // Import AES key
            async importKey(keyBytes) {
                return await window.crypto.subtle.importKey(
                    'raw',
                    keyBytes,
                    { name: 'AES-GCM' },
                    false,
                    ['encrypt', 'decrypt']
                );
            },

            // Encrypt data
            async encrypt(data, key) {
                const iv = this.randomBytes(12);
                const cryptoKey = await this.importKey(key);
                const encrypted = await window.crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv },
                    cryptoKey,
                    data
                );

                // Combine IV and encrypted data
                const result = new Uint8Array(iv.length + encrypted.byteLength);
                result.set(iv);
                result.set(new Uint8Array(encrypted), iv.length);
                return this.bytesToBase64(result);
            },

            // Decrypt data
            async decrypt(encryptedBase64, key) {
                const encryptedData = this.base64ToBytes(encryptedBase64);
                const iv = encryptedData.slice(0, 12);
                const ciphertext = encryptedData.slice(12);

                const cryptoKey = await this.importKey(key);
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv },
                    cryptoKey,
                    ciphertext
                );

                return new Uint8Array(decrypted);
            }
        };

        // Content management
        const contentManager = {
            // Generate Shamir shares
            generateShares(totalShares, requiredShares) {
                const key = crypto.randomBytes(32);
                const keyHex = crypto.bytesToHex(key);
                const shares = secrets.share(keyHex, totalShares, requiredShares);
                return {
                    key: keyHex,
                    shares: shares
                };
            },

            // Combine shares to reconstruct key
            combineShares(shares) {
                try {
                    return secrets.combine(shares);
                } catch (e) {
                    throw new Error('Invalid or insufficient shares');
                }
            },

            // Encrypt content
            async encryptContent(content, key) {
                const data = new TextEncoder().encode(JSON.stringify(content));
                const keyBytes = crypto.hexToBytes(key);
                return await crypto.encrypt(data, keyBytes);
            },

            // Decrypt content
            async decryptContent(encryptedContent, key) {
                const keyBytes = crypto.hexToBytes(key);
                const decryptedData = await crypto.decrypt(encryptedContent, keyBytes);
                const json = new TextDecoder().decode(decryptedData);
                return JSON.parse(json);
            },

            // Convert file to base64
            async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            // Create blob URL from base64
            base64ToBlob(base64, mimeType) {
                const bytes = crypto.base64ToBytes(base64);
                return new Blob([bytes], { type: mimeType });
            }
        };

        // UI Management
        const ui = {
            // Show/hide views
            showView(viewId) {
                document.querySelectorAll('#main-view, #decryption-view, #content-view, #admin-view')
                    .forEach(view => view.classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
            },

            // Show error message
            // Show error message
            showError(message, containerId = 'editor-messages') {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `<div class="error">${message}</div>`;
                } else {
                    console.error('Error (container not found):', message);
                    alert(message);
                }
            },

            // Show success message
            showSuccess(message, containerId = 'editor-messages') {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `<div class="success">${message}</div>`;
                }
            },

            // Clear messages
            clearMessages(containerId = 'editor-messages') {
                const container = document.getElementById(containerId);
                if (container) container.innerHTML = '';
            },

            // Apply internationalization
            currentLang: 'en',

            setLanguage(lang) {
                this.currentLang = lang;
                document.documentElement.lang = lang;
                this.applyI18n();
                
                // Re-render dynamic content based on visible view
                if (!document.getElementById('main-view').classList.contains('hidden')) {
                    renderContentList();
                }
                if (!document.getElementById('admin-view').classList.contains('hidden')) {
                    renderDashboard();
                }
            },

            t(key) {
                const lang = this.currentLang;
                const texts = i18n[lang] || i18n['en'];
                return texts[key] || key;
            },
            
            applyI18n(container = document) {
                const lang = this.currentLang;
                const texts = i18n[lang] || i18n['en'];
                
                // Update elements with data-i18n attribute
                container.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (texts[key]) {
                        if ((element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') && element.getAttribute('placeholder')) {
                            element.placeholder = texts[key];
                        } else {
                            element.textContent = texts[key];
                        }
                    }
                });
                
                // Update elements with data-i18n-placeholder attribute (for inputs with separate text content)
                container.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-i18n-placeholder');
                    if (texts[key]) {
                        element.placeholder = texts[key];
                    }
                });
                
                // Update specific elements that might not be caught by querySelectorAll if simpler logic used before
            }
        };



        // Initialize application
        async function init() {
            // Fetch the original file to preserve formatting
            try {
                const url = window.location.origin + window.location.pathname;
                const response = await fetch(url);
                initialHTML = await response.text();
                initialHTML = initialHTML.replace(/<script[^>]*id="embedded-data"[^>]*>[\s\S]*?<\/script>/i, '');
            } catch (e) {
                console.warn('Could not fetch original HTML' + e);
                ui.showError('Could not fetch original HTML, saving in the admin-area will not work.');
                initialHTML = "";
            }

            loadData();



            // Check if admin mode
            if (window.location.hash.includes('admin')) {
                appData.isAdmin = true;
                showAdminView();
            } else {
                showMainView();
            }

            ui.applyI18n();
        }

        // Load data from embedded script or localStorage
        function loadData() {
            try {
                // Try to load from embedded data first
                const embeddedData = getEmbeddedData();
                if (embeddedData) {
                    // Check if it's the new format with contents and settings
                    if (embeddedData.contents) {
                         appData.contents = embeddedData.contents;
                         appData.settings = embeddedData.settings || { greeting: '' };
                    } else {
                        // Previous versions might have just been an array, but we strictly support the object format now
                        // or initialize empty if structure doesn't match
                        console.warn("Unknown data format, initializing empty.");
                        appData.contents = [];
                        appData.settings = { greeting: '' };
                    }
                    
                    initialHTML = initialHTML.replace(/<script[^>]*id="embedded-data"[^>]*>[\s\S]*?<\/script>/i, '');
                    return;
                }

                appData.contents = [];
            } catch (e) {
                console.error('Error loading data:', e);
                appData.contents = [];
            }
        }


        // Get embedded data (looks for embedded script element)
        function getEmbeddedData() {
            const dataElement = document.getElementById('embedded-data');
            if (dataElement) {
                try {
                    return JSON.parse(dataElement.textContent);
                } catch (e) {
                    console.error('Error parsing embedded data:', e);
                }
            }
            return null;
        }

        // Main view functions
        function showMainView() {
            ui.showView('main-view');
            
            // Handle Greeting
            const greetingContainer = document.getElementById('main-greeting-container');
            const introText = document.querySelector('[data-i18n="app.intro"]');
            
            if (appData.contents.length === 0) {
                 greetingContainer.classList.add('hidden');
            } else {
                 greetingContainer.classList.remove('hidden');
                 if (appData.settings && appData.settings.greeting) {
                     let greeting = appData.settings.greeting;
                     
                     // Collect all names
                     let allNames = new Set();
                     appData.contents.forEach(c => {
                         if (c.shareNames) {
                             c.shareNames.forEach(n => allNames.add(n));
                         }
                     });
                     
                     const namesString = Array.from(allNames).join(', ') || "Key Holders";
                     greeting = greeting.replace(/{names}|{person}/g, namesString);
                     
                     if (introText) introText.textContent = greeting;
                     // Disable i18n update for this element if custom text is set
                     introText.removeAttribute('data-i18n');
                 } else {
                     // Restore default
                     introText.setAttribute('data-i18n', 'app.intro');
                     introText.textContent = i18n['en']['app.intro'];
                 }
            }
            
            renderContentList();
        }

        function renderContentList() {
            const container = document.getElementById('content-list');
            const lang = ui.currentLang;
            const texts = i18n[lang] || i18n['en'];

            if (appData.contents.length === 0) {
                container.innerHTML = `<p data-i18n="app.noContent">${ui.t('app.noContent')}</p>`;
                return;
            }

            container.innerHTML = '';
            const template = document.getElementById('tmpl-content-item');

            appData.contents.forEach(content => {
                const clone = template.content.cloneNode(true);
                
                const metaText = ui.t('content.requirements')
                    .replace('{req}', content.requiredShares)
                    .replace('{total}', content.totalShares);
                
                clone.querySelector('.content-name').textContent = content.name;
                clone.querySelector('.content-meta').textContent = metaText;
                clone.querySelector('.content-desc').textContent = content.description;
                
                const btn = clone.querySelector('.btn-access');
                btn.onclick = () => startDecryption(content.id);
                
                container.appendChild(clone);
            });
            
            ui.applyI18n(container);
        }

        // Decryption functions
        function startDecryption(contentId) {
            const content = appData.contents.find(c => c.id === contentId);
            if (!content) return;

            appData.currentContent = content;
            ui.showView('decryption-view');

            document.getElementById('decrypt-title').textContent = content.name;
            document.getElementById('decrypt-description').textContent = content.description;

            renderPasswordInputs(content.requiredShares);
        }

        function renderPasswordInputs(requiredShares) {
            const container = document.getElementById('password-inputs');
            container.innerHTML = '';
            
            // Show Key Holders if available
            const content = appData.currentContent;
            if (content.shareNames && content.shareNames.length > 0) {
                const holdersList = document.createElement('div');
                holdersList.className = 'key-holders-list';
                holdersList.innerHTML = `<strong>${ui.t('decrypt.keyHolders')}</strong> ` + content.shareNames.map(escapeHtml).join(', ');
                container.appendChild(holdersList);
            }

            for (let i = 0; i < requiredShares; i++) {
                const div = document.createElement('div');
                div.className = 'password-input';
                div.innerHTML = `
                    <label>${ui.t('decrypt.shareLabel').replace('{n}', i+1)}</label>
                    <input type="password" id="password-${i}" required placeholder="${ui.t('decrypt.enterShareKey')}" data-i18n="decrypt.enterShareKey">
                `;
                container.appendChild(div);
            }

        }

        async function attemptDecryption() {
            try {
                const passwords = [];
                const requiredShares = appData.currentContent.requiredShares;

                // Collect passwords
                for (let i = 0; i < requiredShares; i++) {
                    const password = document.getElementById(`password-${i}`).value.trim();
                    if (!password) {
                        throw new Error(ui.t('error.enterPasswords'));
                    }
                    passwords.push(password);
                }

                // Combine shares to get encryption key
                const encryptionKey = contentManager.combineShares(passwords);

                // Decrypt content
                const decryptedContent = await contentManager.decryptContent(
                    appData.currentContent.encryptedData,
                    encryptionKey
                );

                // Show decrypted content immediately
                showDecryptedContent(decryptedContent);

            } catch (error) {
                ui.showError(error.message, 'decrypt-messages');
            }
        }

        function showDecryptedContent(content) {
            ui.showView('content-view');

            document.getElementById('content-title').textContent = appData.currentContent.name;
            document.getElementById('content-description').textContent = appData.currentContent.description || '';
            document.getElementById('content-text').innerHTML = `<pre>${escapeHtml(content.text || '')}</pre>`;
            const filesList = document.getElementById('content-files');
            filesList.innerHTML = '';

            if (content.files && content.files.length > 0) {
                const template = document.getElementById('tmpl-decrypted-file');
                content.files.forEach(file => {
                    const blob = contentManager.base64ToBlob(file.data, file.type);
                    const url = URL.createObjectURL(blob);

                    const clone = template.content.cloneNode(true);
                    const link = clone.querySelector('.file-list-item');
                    link.href = url;
                    link.download = file.name;
                    clone.querySelector('.file-name').textContent = file.name;
                    clone.querySelector('.file-meta').textContent = file.type || 'unknown type';
                    
                    filesList.appendChild(clone);
                });
            } else {
                filesList.innerHTML = '<li>' + ui.t('decrypt.noFiles') + '</li>';
            }
            
            // Show recovered keys if available
            const recoveredKeysContainer = document.getElementById('recovered-keys-container');
            if (recoveredKeysContainer) {
                 recoveredKeysContainer.innerHTML = ''; // Clear previous
                 if (content.shares && content.shares.length > 0) {
                     const details = document.createElement('details');
                     details.className = 'keys-details';
                     
                     const summary = document.createElement('summary');
                     summary.className = 'keys-summary';
                     summary.textContent = ui.t('decrypt.viewKeys');
                     details.appendChild(summary);
                     
                     const list = document.createElement('div');
                     list.className = 'recovered-keys-list';
                     
                     // Try to map names if available
                     const names = appData.currentContent.shareNames || [];
                     
                     const templateKey = document.getElementById('tmpl-recovered-key');
                     
                     content.shares.forEach((share, index) => {
                         const name = names[index] || `Person ${index+1}`;
                         
                         const clone = templateKey.content.cloneNode(true);
                         clone.querySelector('.share-index').textContent = `#${index+1}`;
                         clone.querySelector('.share-name').textContent = name;
                         clone.querySelector('.share-value').textContent = share;
                         
                         const copyBtn = clone.querySelector('.share-copy-btn');
                         copyBtn.onclick = function() {
                             navigator.clipboard.writeText(share);
                             const original = this.innerText;
                             this.innerText = ui.t('common.copied');
                             setTimeout(() => this.innerText = original, 2000);
                         };
                         
                         list.appendChild(clone);
                     });
                     
                     details.appendChild(list);
                     recoveredKeysContainer.appendChild(details);
                 }
            }
        }

        // Admin functions
        function showAdminView() {
            ui.showView('admin-dashboard-view');
            // Ensure appData.settings is initialized
            if (!appData.settings) appData.settings = { greeting: '' };

            // Initialize vault session if not present
            if (!appData.vaultSession) appData.vaultSession = {};
            
            // Set global greeting value
            const greetingInput = document.getElementById('global-greeting-input');
            if (greetingInput) greetingInput.value = appData.settings.greeting || '';
            
            renderDashboard();
        }
        
        function renderDashboard() {
            const grid = document.getElementById('dashboard-vaults-grid');
            if (!grid) return;
            
            // Toggle visibility of Unlock All button - show only when some vaults are locked
            const unlockBtn = document.getElementById('btn-unlock-all');
            if (unlockBtn) {
                const hasVaults = appData.contents && appData.contents.length > 0;
                const hasLockedVaults = hasVaults && appData.contents.some(c => !appData.vaultSession?.[c.id]?.masterKey);
                
                if (hasLockedVaults) {
                    unlockBtn.classList.remove('hidden');
                } else {
                    unlockBtn.classList.add('hidden');
                }
            }

            // Keep the "Add New" card (first child)
            const addCard = grid.firstElementChild;
            grid.innerHTML = '';
            
            // Only show "Add New" if serving via HTTP/HTTPS
            const isSecureOrigin = window.location.protocol === 'http:' || window.location.protocol === 'https:';
            if (isSecureOrigin) {
                grid.appendChild(addCard);
            }
            
            const vaultCardTemplate = document.getElementById('tmpl-vault-card');
            appData.contents.forEach((content) => {
                const clone = vaultCardTemplate.content.cloneNode(true);
                const card = clone.querySelector('.vault-card');
                card.onclick = () => openVaultEditor(content.id);
                
                const shareCount = content.totalShares || 0;
                const reqCount = content.requiredShares || 0;
                const people = content.shareNames ? content.shareNames.join(', ') : ui.t('admin.noOwners');
                
                clone.querySelector('.vault-card-badge').textContent = `${reqCount}/${shareCount} ${ui.t('admin.sharesBadge')}`;
                clone.querySelector('.vault-card-title').textContent = content.name || 'Untitled Vault';
                clone.querySelector('.vault-card-desc').textContent = content.description || 'No description';
                clone.querySelector('.vault-card-owners').textContent = people.substring(0, 40) + (people.length > 40 ? '...' : '');
                
                grid.appendChild(clone);
            });
            
            // Update Distribution Center
            renderDistributionCenter();
        }

        function updateGlobalGreeting(val) {
             appData.settings.greeting = val;
             renderDistributionCenter();
        }
        

        
        async function unlockAllVaults() {
             // Identify locked vaults
             const locked = appData.contents.filter(c => !appData.vaultSession?.[c.id]?.masterKey);
             
             if (locked.length === 0 && appData.contents.length > 0) {
                 if (!confirm(ui.t('confirm.alreadyUnlocked'))) {
                     return;
                 }
             }
             
             if (appData.contents.length === 0) {
                 alert("No vaults to unlock.");
                 return;
             }
             
             
             // Create temporary full-screen overlay for bulk key entry
             
             const overlay = document.createElement('div');
             overlay.id = 'bulk-unlock-overlay';
             overlay.className = 'bulk-unlock-overlay';
             
             const card = document.createElement('div');
             card.className = 'card bulk-unlock-card'; // reuse card class

             
             card.innerHTML = `
                 <h2 data-i18n="unlock.title">Enter Master Keys</h2>
                 <p data-i18n="unlock.description">Enter the master key for each vault to generate distribution messages.</p>
                 <div id="bulk-inputs"></div>
                 <div class="modal-actions">
                     <button class="btn btn-secondary" id="btn-cancel-bulk" data-i18n="common.cancel">Cancel</button>
                     <button class="btn" id="btn-save-bulk" data-i18n="unlock.confirm">Unlock All</button>
                 </div>
             `;
             ui.applyI18n(card);
             
             const inputsContainer = card.querySelector('#bulk-inputs');
             
             appData.contents.forEach(content => {
                 const row = document.createElement('div');
                 row.className = 'unlock-input-row';
                 
                 const label = document.createElement('label');
                 label.textContent = content.name;
                 
                 const input = document.createElement('input');
                 input.type = 'text';
                 input.value = appData.vaultSession?.[content.id]?.masterKey || '';
                 input.setAttribute('data-i18n', 'unlock.placeholder');
                 input.placeholder = 'Enter Master Key';
                 input.dataset.id = content.id;
                 
                 row.appendChild(label);
                 row.appendChild(input);
                 inputsContainer.appendChild(row);
             });
             
             overlay.appendChild(card);
             document.body.appendChild(overlay);
             
             // Handlers
             document.getElementById('btn-cancel-bulk').onclick = () => {
                 document.body.removeChild(overlay);
             };
             
             document.getElementById('btn-save-bulk').onclick = async () => {
                 const inputs = inputsContainer.querySelectorAll('input');
                 if (!appData.vaultSession) appData.vaultSession = {};
                 
                 // Decrypt each vault to cache shares
                 for (const inp of inputs) {
                     const val = inp.value.trim();
                     const contentId = inp.dataset.id;
                     if (val) {
                         const content = appData.contents.find(c => c.id === contentId);
                         if (content) {
                             try {
                                 const decrypted = await contentManager.decryptContent(content.encryptedData, val);
                                 appData.vaultSession[contentId] = {
                                     masterKey: val,
                                     shares: decrypted.shares || []
                                 };
                             } catch (e) {
                                 // Invalid key - still store master key, shares will be empty
                                 if (!appData.vaultSession[contentId]) {
                                     appData.vaultSession[contentId] = {};
                                 }
                                 appData.vaultSession[contentId].masterKey = val;
                                 console.log('Could not decrypt vault ' + contentId + ': ' + e);
                             }
                         }
                     }
                 }
                 
                 renderDashboard();
                 renderDistributionCenter();
                 document.body.removeChild(overlay);
             };
        }
        


        function exitAdmin() {
            appData.isAdmin = false;
            window.location.hash = '';
            showMainView();
        }



        function populateEditor() {
            // Legacy function - elements may not exist
            if (!appData.workingContent) return;
            
            const editName = document.getElementById('edit-name');
            const editDesc = document.getElementById('edit-description');
            const editTotal = document.getElementById('edit-total-shares');
            const editReq = document.getElementById('edit-required-shares');
            const editText = document.getElementById('edit-text');
            const fileInput = document.getElementById('file-input');
            const saveBtn = document.getElementById('btn-save-content');
            const saveError = document.getElementById('save-error-message');
            
            // Skip if legacy elements don't exist
            if (!editName) return;

            editName.value = appData.workingContent.name || '';
            if (editDesc) editDesc.value = appData.workingContent.description || '';
            if (editTotal) editTotal.value = appData.workingContent.totalShares || 5;
            if (editReq) editReq.value = appData.workingContent.requiredShares || 3;
            if (editText) editText.value = appData.workingContent.text || '';



            if (fileInput) fileInput.value = '';
            updateFilePreview(appData.workingContent.files || []);

            ui.clearMessages();
            
            if (!initialHTML) {
                if (saveBtn) saveBtn.classList.add('hidden');
                if (saveError) saveError.classList.remove('hidden');
            } else {
                if (saveBtn) saveBtn.classList.remove('hidden');
                if (saveError) saveError.classList.add('hidden');
            }
        }

        async function editContent(contentId, providedKey = null) {
            const content = appData.contents.find(c => c.id === contentId);
            if (!content) return false;

            let masterKey = providedKey || appData.vaultSession?.[contentId]?.masterKey;
            if (!masterKey) {
                 masterKey = prompt(ui.t('prompt.enterMasterKey'));
            }
            if (!masterKey) return false; // Cancelled
            
            // Attempt to decrypt with the provided key

            try {
                // Decrypt existing content
                const decryptedContent = await contentManager.decryptContent(content.encryptedData, masterKey);

                // Set up working content with existing data
                appData.workingContent = {
                    id: contentId,  // non-null means editing existing
                    name: content.name,
                    description: content.description,
                    totalShares: content.totalShares,
                    requiredShares: content.requiredShares,
                    text: decryptedContent.text || '',
                    files: decryptedContent.files || [],
                    masterKey: masterKey,
                    shareNames: content.shareNames || [],
                    shares: decryptedContent.shares || [] // Recover original shares if available
                };

                // Cache the vault session (master key + shares)
                if (!appData.vaultSession) appData.vaultSession = {};
                appData.vaultSession[contentId] = {
                    masterKey: masterKey,
                    shares: decryptedContent.shares || []
                };
                
                return true; // Success

            } catch (error) {
                console.log('Invalid master key or corrupted content ' + error);
                alert(ui.t('error.invalidMasterKey'));
            }
        }

        function updateFilePreview(existingFiles = []) {
            // Legacy function - elements may not exist
            const preview = document.getElementById('file-preview');
            if (!preview) return;
            preview.innerHTML = '';

            if (existingFiles.length > 0) {
                const existingFilesList = document.createElement('div');
                existingFilesList.innerHTML = '<h4>Attached Files:</h4>';
                
                const template = document.getElementById('tmpl-file-preview');

                existingFiles.forEach((file, index) => {
                    const clone = template.content.cloneNode(true);
                    
                    clone.querySelector('.file-name-type').innerHTML = `• ${escapeHtml(file.name)} <small>(${file.type || 'unknown'})</small>`;
                    
                    const badge = clone.querySelector('.file-badge');
                    if (file.isNew) {
                         badge.className = 'badge-available';
                         badge.textContent = 'New';
                    } else {
                         badge.className = 'badge-pending';
                         badge.textContent = 'Existing';
                    }

                    const downloadLink = clone.querySelector('.file-download-link');
                    try {
                        const blob = contentManager.base64ToBlob(file.data, file.type || 'application/octet-stream');
                        const url = URL.createObjectURL(blob);
                        downloadLink.href = url;
                        downloadLink.download = file.name;
                    } catch (e) {
                         console.warn('Could not create preview link', e);
                         downloadLink.style.display = 'none';
                    }

                    const removeBtn = clone.querySelector('.file-remove-btn');
                    removeBtn.onclick = () => removeExistingFile(index);

                    existingFilesList.appendChild(clone);
                });

                preview.appendChild(existingFilesList);
            }
        }

        function removeExistingFile(index) {
            if (appData.workingContent && appData.workingContent.files) {
                appData.workingContent.files.splice(index, 1);
                updateFilePreview(appData.workingContent.files);
            }
        }






        // Utility functions
        function generateId() {
            return 'content_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Generate updated file with embedded data
        async function downloadSecureFile() {
             if (appData.contents.length === 0) {
                 ui.showError(ui.t('error.noContent'));
                 return;
             }
             await generateUpdatedFile();
        }

        function generateUpdatedFile() {
            // Use the fetched HTML which preserves formatting
            let htmlContent = initialHTML;

            // Remove existing embedded data if present
            htmlContent = htmlContent.replace(/<script[^>]*id="embedded-data"[^>]*>[\s\S]*?<\/script>/i, '');

            // Create new embedded data script with proper indentation
            const dataToSave = {
                contents: appData.contents,
                settings: appData.settings
            };
            
            const indentedJson = JSON.stringify(dataToSave, null, 4)
                .split('\n')
                .map(line => line ? '        ' + line : line) // Add 8 spaces for proper HTML indentation
                .join('\n');

            // Do not inline the following variable!  Otherwise we will remove it when trying to remove the "real" embedded-data
            const embeddedDataId = 'embedded-data';
            const dataScript = `    <script type="application/json" id="${embeddedDataId}">
${indentedJson}
    <\/script>`;

            // Insert data script before the closing head tag
            const updatedHtml = htmlContent.replace('</head>', dataScript + '\n</head>');

            // Create downloadable file
            const blob = new Blob([updatedHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'secure-instructions-updated.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);

            ui.showSuccess(ui.t('success.generated'));
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', init);

        // Handle hash changes
        // Check for HTTP/HTTPS protocol
        const isSecureOrigin = window.location.protocol === 'http:' || window.location.protocol === 'https:';
        
        // Hide "Create New Vault" button if not secure
        if (!isSecureOrigin) {
            const createBtn = document.getElementById('main-create-btn');
            if (createBtn) createBtn.style.display = 'none';
        }

        // Handle hash changes
        window.addEventListener('hashchange', function () {
            if (window.location.hash === '#admin') {
                if (!isSecureOrigin) {
                    alert(ui.t('error.adminHttps') + '\n\n' + 'Please run a local server (e.g., "python3 -m http.server") to create or edit instructions.');
                    window.location.hash = ''; // Reset
                    return;
                }
                
                if (!appData.isAdmin) {
                    appData.isAdmin = true;
                    showAdminView();
                }
            } else {
                if (appData.isAdmin) {
                    appData.isAdmin = false;
                    showMainView();
                }
            }
        });
        
        // Initial Hash Check
        if (window.location.hash === '#admin') {
             if (!isSecureOrigin) {
                 setTimeout(() => {
                     alert(ui.t('error.adminHttps') + '\n\n' + 'Please run a local server (e.g., "python3 -m http.server") to create or edit instructions.');
                     window.location.hash = '';
                 }, 100);
             } else {
                 if (!appData.isAdmin) {
                    appData.isAdmin = true;
                    showAdminView();
                 }
             }
        }

        // Prevent form submission on enter in password fields
        document.addEventListener('keypress', function (e) {
            if (e.target.type === 'password' && e.key === 'Enter') {
                e.preventDefault();
                if (document.getElementById('decryption-view').classList.contains('hidden') === false) {
                    attemptDecryption();
                }
            }
        });


        // Modal Logic - variables must be declared before exports
        let currentModalVaultId = null;
        let currentModalFiles = [];

        // Export functions to global scope for onclick handlers
        window.showMainView = showMainView;
        window.startDecryption = startDecryption;
        window.attemptDecryption = attemptDecryption;
        // window.showAdminList = showAdminList;
        // window.showCreateContent = showCreateContent;
        window.editContent = editContent;
        // window.deleteContent = deleteContent;
        // window.generateShares = generateShares;
        // window.proceedToContent = proceedToContent;
        // window.saveContent = saveContent;
        window.exitAdmin = exitAdmin;
        window.removeExistingFile = removeExistingFile;
        // window.showSettings = showSettings;
        // window.saveSettings = saveSettings;
        window.openVaultEditor = openVaultEditor;
        window.closeVaultModal = closeVaultModal;
        window.renderShareTable = renderShareTable;
        window.saveVaultFromModal = saveVaultFromModal;
        window.deleteVaultFromModal = deleteVaultFromModal;
        window.handleModalFiles = handleModalFiles;
        window.updateGlobalGreeting = updateGlobalGreeting;

        function openVaultEditor(id = null) {
            currentModalVaultId = id;
            const modal = document.getElementById('vault-modal');
            modal.classList.remove('hidden');
            const modalTitle =document.getElementById('modal-title');
            
            // Reset fields
            currentModalFiles = [];
            document.getElementById('modal-file-list').innerHTML = '';
            document.getElementById('modal-file-input').value = '';
            
            if (id) {
                // Edit Mode
                modalTitle.setAttribute('data-i18n', 'editor.titleEdit');
                ui.applyI18n(modal); // Update title text immediately

                const content = appData.contents.find(c => c.id === id);
                if (!content) return closeVaultModal();
                
                // Populate metadata fields from stored content
                document.getElementById('modal-vault-name').value = content.name;
                document.getElementById('modal-vault-desc').value = content.description;
                document.getElementById('modal-total-shares').value = content.totalShares;
                document.getElementById('modal-required-shares').value = content.requiredShares;
                
                // Try to get master key from vault session cache
                let cachedKey = appData.vaultSession?.[id]?.masterKey;
                
                let promise = editContent(id, cachedKey);
                
                promise.then((success) => {
                    if (!success) {
                        // User cancelled or failed. Do not open modal.
                        return; 
                    }
                    
                    document.getElementById('vault-modal').classList.remove('hidden');

                    // Populate modal from appData.workingContent
                    if (appData.workingContent) {
                         const wc = appData.workingContent;
                         document.getElementById('modal-vault-name').value = wc.name;
                         document.getElementById('modal-vault-desc').value = wc.description;
                         document.getElementById('modal-vault-text').value = wc.text;
                         document.getElementById('modal-total-shares').value = wc.totalShares;
                         document.getElementById('modal-required-shares').value = wc.requiredShares;
                         document.getElementById('modal-master-key').value = wc.masterKey;
                         
                         // Helper: Restore file list
                         currentModalFiles = wc.files || [];
                         const list = document.getElementById('modal-file-list');
                         list.innerHTML = '';
                         currentModalFiles.forEach(f => {
                             const li = document.createElement('li');
                             const size = Math.round(f.data.length * 0.75 / 1024);
                             const dataUrl = `data:${f.type};base64,${f.data}`;
                             li.innerHTML = `
                                <a href="${dataUrl}" download="${f.name}" class="file-list-item" target="_blank">
                                    <div class="file-icon">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                                    </div>
                                    <div class="file-info">
                                        <span class="file-name">${f.name}</span>
                                        <span class="file-meta">${size} KB</span>
                                    </div>
                                    <span class="modal-file-remove" onclick="event.preventDefault(); event.stopPropagation(); this.closest('li').remove();">×</span>
                                </a>
                             `;
                             list.appendChild(li);
                         });

                         // Use shares from vault session (already cached by editContent)
                         const sharesToDisplay = appData.vaultSession?.[id]?.shares || wc.shares || [];
                         
                         renderShareTable(false, wc.shareNames, sharesToDisplay); 
                    }
                });
                
            } else {
                // New Vault
                modalTitle.setAttribute('data-i18n', 'editor.titleNew');
                ui.applyI18n(modal);

                document.getElementById('vault-modal').classList.remove('hidden');
                document.getElementById('modal-vault-name').value = '';
                document.getElementById('modal-vault-desc').value = '';
                document.getElementById('modal-vault-text').value = '';
                document.getElementById('modal-total-shares').value = 3;
                document.getElementById('modal-required-shares').value = 2;
                document.getElementById('modal-file-list').innerHTML = '';
                currentModalFiles = [];
                renderShareTable(true); // Generate new keys
            }
            
            // Populate Autocomplete
            const datalist = document.getElementById('all-share-names');
            datalist.innerHTML = '';
            const allNames = new Set();
            appData.contents.forEach(c => {
                if (c.shareNames) c.shareNames.forEach(n => { if(n) allNames.add(n) });
            });
            allNames.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                datalist.appendChild(opt);
            });
        }
        
        function closeVaultModal() {
            document.getElementById('vault-modal').classList.add('hidden');
        }
        
        function renderShareTable(generateNew = false, existingNames = [], existingShares = null) {
             const total = parseInt(document.getElementById('modal-total-shares').value);
             const container = document.getElementById('modal-share-table');
             
             let shares = [];
             let masterKey = document.getElementById('modal-master-key').value;
             
             if (generateNew || (!masterKey && !existingShares)) {
                 const req = parseInt(document.getElementById('modal-required-shares').value);
                 try {
                    const result = contentManager.generateShares(total, req);
                    shares = result.shares;
                    masterKey = result.key;
                    document.getElementById('modal-master-key').value = masterKey;
                 } catch(e) { console.error(e); }
             } else {
                 if (existingShares && existingShares.length === total) {
                     shares = existingShares;
                 } else {
                     // Display placeholder dots when shares aren't available
                     shares = new Array(total).fill('••••••••••••••••••••••••••••');
                 }
             }
             

             
             container.innerHTML = '';
             const wrapper = document.createElement('div');
             wrapper.className = 'share-table-wrapper';
             
             const template = document.getElementById('tmpl-share-row-modal');

             for(let i=0; i<total; i++) {
                 const name = existingNames[i] || ''; // Try to match existing name
                 
                 const clone = template.content.cloneNode(true);
                 ui.applyI18n(clone);
                 clone.querySelector('.share-index').textContent = `#${i+1}`;
                 
                 const nameInput = clone.querySelector('.share-name-input-modal');
                 nameInput.value = name;
                 
                 const shareInput = clone.querySelector('.share-value-input');
                 shareInput.value = shares[i];
                 
                 const copyBtn = clone.querySelector('.share-copy-btn');
                 // Closure to capture shareInput
                 copyBtn.onclick = function() {
                      navigator.clipboard.writeText(shareInput.value);
                      const originalText = this.innerText;
                      this.innerText = ui.t('common.copied');
                      setTimeout(() => this.innerText = originalText, 2000);
                 };

                 wrapper.appendChild(clone);
             }
             container.appendChild(wrapper);
        }

        async function saveVaultFromModal() {
             const name = document.getElementById('modal-vault-name').value;
             const desc = document.getElementById('modal-vault-desc').value;
             const text = document.getElementById('modal-vault-text').value;
             const total = parseInt(document.getElementById('modal-total-shares').value);
             const req = parseInt(document.getElementById('modal-required-shares').value);
             const masterKey = document.getElementById('modal-master-key').value;
             
             if (!name || !text) { alert(ui.t('error.nameRequired')); return; }
             
             // Collect Names
             const inputs = document.querySelectorAll('.share-name-input-modal');
             const shareNames = Array.from(inputs).map(i => i.value.trim());
             
             // Collect Shares (read from DOM inputs)
             const inputsShares = document.querySelectorAll('#modal-share-table input[readonly]');
             const currentShares = Array.from(inputsShares).map(i => i.value);
             const hasDots = currentShares.some(s => s.includes('••••'));
             
             // Get valid shares: either from DOM or from existing vaultSession
             let sharesToEncrypt = [];
             if (!hasDots) {
                 sharesToEncrypt = currentShares;
             } else if (appData.vaultSession?.[currentModalVaultId]?.shares) {
                 sharesToEncrypt = appData.vaultSession[currentModalVaultId].shares;
             }
             
             // Encrypt (including shares for recovery)
             const contentToEncrypt = { text, files: currentModalFiles, shares: sharesToEncrypt };
             const encryptedData = await contentManager.encryptContent(contentToEncrypt, masterKey);
             
             // Create Object
             const vault = {
                 id: currentModalVaultId || generateId(),
                 name,
                 description: desc,
                 totalShares: total,
                 requiredShares: req,
                 encryptedData: encryptedData,
                 shareNames: shareNames,
                 created: new Date().toISOString()
             };
             
             // Cache vault session state (master key + shares)
             if (!appData.vaultSession) appData.vaultSession = {};
             if (!hasDots) {
                 appData.vaultSession[vault.id] = {
                     masterKey: masterKey,
                     shares: currentShares
                 };
             } else if (appData.vaultSession[vault.id]) {
                 appData.vaultSession[vault.id].masterKey = masterKey;
             }
             
             // Save to AppData
             if (currentModalVaultId) {
                 const idx = appData.contents.findIndex(c => c.id === currentModalVaultId);
                 appData.contents[idx] = vault;
             } else {
                 appData.contents.push(vault);
             }
             
             closeVaultModal();
             renderDashboard();
        }
        
        function deleteVaultFromModal() {
            if (currentModalVaultId && confirm(ui.t('confirm.deleteVault'))) {
                appData.contents = appData.contents.filter(c => c.id !== currentModalVaultId);
                closeVaultModal();
                renderDashboard();
            }
        }
        
        function renderDistributionCenter() {
             const container = document.getElementById('distribution-center-list');
             if (!container) return;
             
             // Get i18n texts FIRST (before any usage)
             const lang = ui.currentLang;
             const texts = i18n[lang] || i18n['en'];
             
             // Aggregate data by person
             const personMap = {}; // Name -> { items: [{ vaultName, key }] }
             
             appData.contents.forEach(vault => {
                 const shares = appData.vaultSession?.[vault.id]?.shares;
                 if (!shares) return; // Only show if we have session shares (i.e. created/edited this session)
                 
                 vault.shareNames.forEach((name, index) => {
                     const cleanName = name.trim() || `Person ${index+1}`;
                     if (!personMap[cleanName]) personMap[cleanName] = [];
                     
                     personMap[cleanName].push({
                         vaultName: vault.name,
                         key: shares[index] || 'Error: Key missing'
                     });
                 });
             });
             
             // Clear existing content
             container.innerHTML = '';
             
             if (Object.keys(personMap).length === 0) {
                 container.innerHTML = `<div class="empty-state">
                    <p>${texts['dist.noPlan']}</p>
                    <p class="empty-state-hint">${texts['dist.createVaults']}</p>
                 </div>`;
                 // Don't return, still show admin keys if available
             }
             
             const tmplPersonal = document.getElementById('tmpl-dist-personal');

             for (const [person, items] of Object.entries(personMap)) {
                 const keysList = items.map((item, i) => `${i+1}. "${item.vaultName}": ${item.key}`).join('\n');
                 
                 // Variable Expansion
                 let greeting = appData.settings.greeting || "Here are your secure access keys.";
                 greeting = greeting.replace(/\{names\}/g, person).replace(/\{person\}/g, person);
                 
                 const copyText = `${ui.t('dist.to')} ${person}\n\n${greeting}\n\n${ui.t('dist.keysIntro')}\n\n${keysList}\n\n${ui.t('dist.keepSafe')}`;
                 
                 const clone = tmplPersonal.content.cloneNode(true);
                 ui.applyI18n(clone); // Apply internationalization to static elements
                 
                 clone.querySelector('.dist-person-name').textContent = `${texts['dist.to']} ${person}`;
                 
                 const copyBtn = clone.querySelector('.dist-copy-email-btn');
                 copyBtn.onclick = function() {
                      navigator.clipboard.writeText(copyText);
                      const originalText = this.innerText;
                      this.innerText = ui.t('common.copied');
                      setTimeout(() => this.innerText = originalText, 2000);
                 };
                 
                 const codeBlock = clone.querySelector('.dist-email-text');
                 codeBlock.textContent = copyText.substring(0, 150) + '... ';
                 const hint = document.createElement('span');
                 hint.className = 'hint-text';
                 hint.innerText = texts['dist.clickCopy'];
                 codeBlock.appendChild(hint);
                 
                 container.appendChild(clone);
             }

             // Add Admin Master Keys Block
             const adminKeys = [];
             appData.contents.forEach(vault => {
                 let key = 'Not available (Unlock first)';
                 
                 // Check vault session for master key
                 if (appData.vaultSession?.[vault.id]?.masterKey) {
                     key = appData.vaultSession[vault.id].masterKey;
                 }
                 
                 adminKeys.push({ vaultName: vault.name, key: key });
             });
             
             if (adminKeys.length > 0) {
                 const keysList = adminKeys.map((item, i) => `${i+1}. "${item.vaultName}": ${item.key}`).join('\n');
                 const copyText = `${ui.t('dist.adminKeysTitle')}\n\n${keysList}`;
                 
                 const tmplAdmin = document.getElementById('tmpl-dist-admin');
                 const clone = tmplAdmin.content.cloneNode(true);
                 ui.applyI18n(clone);
                 
                 const copyBtn = clone.querySelector('.dist-copy-keys-btn');
                 copyBtn.onclick = function() {
                      navigator.clipboard.writeText(copyText);
                      const originalText = this.innerText;
                      this.innerText = ui.t('common.copied');
                      setTimeout(() => this.innerText = originalText, 2000);
                 };
                 
                 clone.querySelector('.dist-keys-text').textContent = copyText;
                 container.appendChild(clone);
             }
        }
        
        async function handleModalFiles(input) {
            if (input.files.length === 0) return;
            
            const list = document.getElementById('modal-file-list');
            
            for (const file of input.files) {
                try {
                    const base64Data = await contentManager.fileToBase64(file);
                    currentModalFiles.push({
                        name: file.name,
                        type: file.type,
                        data: base64Data
                    });
                    
                    const li = document.createElement('li');
                    
                    // Create download link logic
                    // base64Data is RAW base64. We need to prepend data URI scheme.
                    const dataUrl = `data:${file.type};base64,${base64Data}`;
                    li.innerHTML = `
                        <a href="${dataUrl}" download="${file.name}" class="file-list-item" target="_blank">
                            <div class="file-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                            </div>
                            <div class="file-info">
                                <span class="file-name">${file.name}</span>
                                <span class="file-meta">${Math.round(file.size/1024)} KB</span>
                            </div>
                            <span class="modal-file-remove" onclick="event.preventDefault(); event.stopPropagation(); this.closest('li').remove();">×</span>
                        </a>
                    `;
                    
                    list.appendChild(li);
                } catch (e) {
                    console.error(e);
                    alert('Error adding file: ' + file.name);
                }
            }
        }

        // Initialize Settings if needed
        if (!appData.settings) appData.settings = {};
    </script>

    <!-- Vault Editor Modal -->
    <div id="vault-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" data-i18n="editor.titleEdit">Edit Vault</h2>
                <button class="btn btn-secondary btn-icon" onclick="closeVaultModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-column-group">
                    <!-- Step 1: Content -->
                    <div class="form-group">
                        <label data-i18n="editor.vaultName">Vault Name</label>
                        <input type="text" id="modal-vault-name" data-i18n-placeholder="editor.vaultNamePlaceholder" placeholder="e.g. Bank Accounts">
                    </div>
                    <div class="form-group">
                        <label data-i18n="editor.vaultDesc">Description (Visible to public)</label>
                        <input type="text" id="modal-vault-desc" data-i18n-placeholder="editor.vaultDescPlaceholder" placeholder="Details about what is inside...">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label data-i18n="editor.secretMessage">Secret Message</label>
                            <textarea id="modal-vault-text" data-i18n="editor.secretPlaceholder" placeholder="Type your secret instructions here..."></textarea>
                        </div>
                        <div class="form-col">
                            <label data-i18n="editor.files">Files (Drag & Drop or Click)</label>
                            <div class="file-drop-zone" 
                                 onclick="document.getElementById('modal-file-input').click()"
                                 ondragover="event.preventDefault(); this.style.background='#f0f9ff';"
                                 ondragleave="this.style.background='transparent';"
                                 ondrop="event.preventDefault(); this.style.background='transparent'; handleModalFiles(event.dataTransfer);">
                                <p class="file-drop-hint" data-i18n="editor.dropFiles">Click or Drop files here</p>
                                <input type="file" id="modal-file-input" multiple class="hidden" onchange="handleModalFiles(this)">
                            </div>
                            <ul id="modal-file-list" class="file-list modal-file-list"></ul>
                        </div>
                    </div>
                    
                    <!-- Step 2: Access & Shares -->
                     <h3 class="access-control-title" data-i18n="editor.shareConfig">Access Control</h3>
                     <div class="share-config-row">
                         <div class="form-col">
                             <label data-i18n="editor.totalShares">Total Shares (How many people?)</label>
                             <input type="number" id="modal-total-shares" value="3" min="2" max="20" onchange="renderShareTable(true)">
                         </div>
                         <div class="form-col">
                             <label data-i18n="editor.requiredShares">Required to Unlock (Threshold)</label>
                             <input type="number" id="modal-required-shares" value="2" min="2" max="20">
                         </div>
                         <div class="share-config-action">
                             <button class="btn btn-secondary" onclick="renderShareTable(true)" data-i18n="editor.regenerate">Regenerate Keys</button>
                         </div>
                         <div class="share-config-copy-action">
                            <!-- Master Key Display -->
                            <div class="master-key-group">
                                <label class="master-key-label" data-i18n="editor.masterKey">Master Key</label>
                                <div class="master-key-wrapper">
                                    <input type="text" id="modal-master-key" readonly class="master-key-input" title="Master Key">
                                    <button class="btn btn-secondary master-key-copy-btn" data-i18n="common.copy" onclick="navigator.clipboard.writeText(document.getElementById('modal-master-key').value); this.innerText=ui.t('common.copied'); setTimeout(()=>this.innerText=ui.t('common.copy'), 1500);">Copy</button>
                                </div>
                            </div>
                         </div>
                     </div>
                     
                     <datalist id="all-share-names"></datalist>
                     
                     <!-- Share Table -->
                     <label data-i18n="editor.generatedShares">Share Holders</label>
                     <div id="modal-share-table" class="share-table-container">
                         <!-- Table populated by JS -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteVaultFromModal()" data-i18n="editor.delete">Delete Vault</button>
                <div class="modal-spacer"></div>
                <button class="btn btn-secondary" onclick="closeVaultModal()" data-i18n="common.cancel">Cancel</button>
                <button class="btn" onclick="saveVaultFromModal()" data-i18n="editor.save">Save Vault</button>
            </div>
        </div>
    </div>
</body>

</html>